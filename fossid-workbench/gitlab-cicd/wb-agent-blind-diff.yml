# Workbench Agent - Differential Blind Scan for Merge Requests
# This workflow runs on merge requests to perform blind scanning of changed files

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

stages:
  - scan
  - evaluate

variables:
  # Set these variables in your GitLab project settings
  # WORKBENCH_URL: "https://your-workbench-instance.com"
  # WORKBENCH_USER: "your-username"
  # WORKBENCH_TOKEN: "your-api-token"
  # QUAY_USER: "your-quay-username"
  # QUAY_TOKEN: "your-quay-token"
  
  # Project and scan naming for blind differential scans
  PROJECT_CODE: "Blind-$CI_PROJECT_PATH"
  SCAN_CODE: "$CI_PROJECT_PATH-$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"

run_blind_differential_scan:
  stage: scan
  image:
    name: quay.io/fossid/workbench-agent:0.7.2
    entrypoint: [""]
  
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0  # Fetch all history for all branches and tags
  
  before_script:
    - mkdir -p results
    - mkdir -p analyzed_code
    - |
      # Fetch base and head branches
      git fetch origin $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
      git fetch origin $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
      
      # Get the list of changed files and create archive
      CHANGED_FILES=$(git diff --name-only --diff-filter=d origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME origin/$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME)
      
      if [ -z "$CHANGED_FILES" ]; then
        echo "âœ… No changed files found"
        echo "HAS_CHANGES=false" >> build.env
      else
        echo "Changed files:"
        echo "$CHANGED_FILES"
        echo "$CHANGED_FILES" | zip -@ diff-archive.zip
        echo "HAS_CHANGES=true" >> build.env
        echo "Archive created: diff-archive.zip"
        ls -la diff-archive.zip
        
        # Extract files for blind scan (directory path required instead of ZIP)
        unzip -q diff-archive.zip -d analyzed_code
        echo "Files extracted from archive:"
        find analyzed_code -type f | head -20
        echo "Total files: $(find analyzed_code -type f | wc -l)"
      fi
  
  script:
    - |
      if [ "$HAS_CHANGES" = "true" ]; then
        # Run Workbench Agent for blind differential scan
        # When using Blind Scan, a path to a directory must be provided instead of the ZIP
        workbench-agent \
          --api_url $WORKBENCH_URL \
          --api_user $WORKBENCH_USER \
          --api_token $WORKBENCH_TOKEN \
          --project_code $PROJECT_CODE \
          --scan_code $SCAN_CODE \
          --blind_scan \
          --path analyzed_code \
          --limit 1 \
          --auto_identification_detect_declaration \
          --auto_identification_detect_copyright \
          --auto_identification_resolve_pending_ids \
          --delta_only \
          --path-result results/wb_result.json
      else
        echo "No file changes detected in this merge request. Skipping scan."
      fi

evaluate_fossid_gates:
  stage: evaluate
  image: python:3.9
  
  dependencies:
    - run_blind_differential_scan
  
  before_script:
    - pip install requests
    - git clone https://github.com/fossid-ab/workbench-api-samples.git
  
  script:
    - |
      if [ "$HAS_CHANGES" = "true" ]; then
        # Check the Workbench Project/Scan for the differential scan
        # to alert if there are pending identifications or policy violations
        python workbench-api-samples/post-scan-gates/post_scan_gates.py \
          --workbench-url $WORKBENCH_URL \
          --workbench-user $WORKBENCH_USER \
          --workbench-token $WORKBENCH_TOKEN \
          --scan-code $SCAN_CODE \
          --show-files \
          --policy-check
      else
        echo "No scan was performed, skipping policy check."
      fi